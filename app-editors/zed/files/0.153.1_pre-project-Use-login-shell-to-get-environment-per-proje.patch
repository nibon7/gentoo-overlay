From c58a55216118c1f6abe37cc4949d0b411e1d0154 Mon Sep 17 00:00:00 2001
From: "gcp-cherry-pick-bot[bot]"
 <98988430+gcp-cherry-pick-bot[bot]@users.noreply.github.com>
Date: Thu, 12 Sep 2024 14:46:31 -0400
Subject: [PATCH] project: Use login shell to get environment per project
 (cherry-pick #17717) (#17720)

Cherry-picked project: Use login shell to get environment per project
(#17717)

This is a follow-up to #17075 to spawn a login shell when getting the
environment for projects.

The reason why we didn't do it before is that we only used the
environment for certain language servers and not a lot of other things,
like tasks.

But with #17075 we now use the project more often and use it as the
_base_ environment for tasks/terminals.

Before the change, terminals and tasks would inherit the Zed process'
environment, including PATH and so on. After the change, we would set
the environment, overwriting the PATH instead of merging. But the
non-login shell environment is a subset of the login-shell environment.


Release Notes:

- Fixed environment variables used per project in terminals/tasks
overwriting the base environment and not making use of a login-shell
environment.

Co-authored-by: Thorsten Ball <mrnugget@gmail.com>
---
 crates/project/src/environment.rs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/crates/project/src/environment.rs b/crates/project/src/environment.rs
index b74b577b39..9742b8b6d5 100644
--- a/crates/project/src/environment.rs
+++ b/crates/project/src/environment.rs
@@ -219,7 +219,7 @@ async fn load_shell_environment(
     );
 
     let output = smol::process::Command::new(&shell)
-        .args(["-i", "-c", &command])
+        .args(["-l", "-i", "-c", &command])
         .envs(direnv_environment)
         .output()
         .await
-- 
2.44.2

